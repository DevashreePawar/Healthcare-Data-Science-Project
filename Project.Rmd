---
title: "Disease Progression Analytics and Dynamic Risk Prediction of Diabetic Complications  
       Using Longitudinal Electronic Health Records"
author: "Devashree Pawar"
date: "12/04/2025"
output: 
  pdf_document:
    fig_caption: yes
    number_sections: yes
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = TRUE)
library(tidyverse)
library(lubridate)
library(lme4)
library(lmerTest)
library(ordinal)
library(cmprsk)
library(survival)
library(tidymodels)
library(xgboost)
library(vip)
library(DALEXtra)
library(ggplot2)
library(dplyr)
library(scales)
library(patchwork)
library(janitor)
theme_set(theme_minimal(base_size = 12))
set.seed(42)
```

# Introduction

Diabetes mellitus, particularly type 2 diabetes, is a chronic, progressive condition responsible for substantial morbidity, mortality, and healthcare expenditure worldwide. Despite advances in therapy, a significant proportion of patients experience worsening glycemic control and develop microvascular and macrovascular complications over time. Understanding the natural history of disease progression and identifying patients at highest risk of adverse outcomes remain critical challenges in clinical practice.

This project combines longitudinal statistical modeling with modern machine learning to provide a comprehensive view of diabetes progression using real-world electronic health records. By leveraging repeated hospital encounters from a large multi-institutional U.S. cohort, we (1) characterize how glycemic control evolves over time, (2) quantify the cumulative incidence of major complications while appropriately accounting for the competing risk of death, and (3) develop and interpret a dynamic predictive model that forecasts the onset of the next major complication using only information available at the current encounter.

The integration of descriptive trajectory analysis, competing-risks survival methods, and interpretable machine learning offers both clinical insight into disease progression patterns and actionable risk stratification tools—bridging traditional biostatistics with contemporary data science approaches in healthcare.

# Introduction to Dataset

The analysis utilizes the publicly available **Diabetes 130-US Hospitals dataset (1999–2008)**, collected from 130 hospitals across the United States and made available through the UCI Machine Learning Repository [\@strack2014]. The dataset contains **101,766 hospital encounters** from **71,490 unique patients** diagnosed with diabetes, spanning a 10-year period.

Key variables include demographic information (age, gender, race), admission source and type, 24 medication indicators, laboratory results (including HbA1c), up to three ICD-9 diagnosis codes, number of procedures, length of stay, and discharge disposition. Crucially, **55,453 patients (78%) have two or more encounters** (totaling 171,142 encounters), enabling true longitudinal and trajectory analyses.

All patient identifiers were removed prior to release, ensuring HIPAA compliance. This dataset has become a benchmark resource for diabetes-related predictive modeling and health services research.

## Data Loading

```{r}
# Load dataset
diab <- read_csv("dataset_diabetes/diabetic_data.csv") %>% clean_names()
id_map <- read_csv("dataset_diabetes/IDs_mapping.csv") %>% clean_names()


# Structure of dataset
glimpse(diab)
summary(diab)

glimpse(id_map)
summary(id_map)
```

## Data cleaning

```{r}
## ============================
## DATA CLEANING PIPELINE (FIXED)
## ============================

library(dplyr)
library(janitor)
library(forcats)

# 1. Clean column names
diab <- diab %>% clean_names()
id_map <- id_map %>% clean_names()

# 2. Replace "?" with NA *only for character columns*
diab <- diab %>%
  mutate(across(where(is.character), ~na_if(., "?")))

# 3. Convert character columns to factors
diab <- diab %>%
  mutate(across(where(is.character), as.factor))

# 4. Convert id_map IDs to numeric if needed
id_map <- id_map %>%
  mutate(across(where(is.character), as.numeric))

# 5. Join readable admission type descriptions
id_map_clean <- id_map %>%
  rename(admission_type_desc = description)

diab <- diab %>%
  left_join(id_map_clean, by = "admission_type_id")

# 6. Lump rare medical specialties
diab <- diab %>%
  mutate(medical_specialty = fct_lump(medical_specialty, n = 10))

# 7. Convert age bracket to numeric midpoint
diab <- diab %>%
  mutate(age_num = case_when(
    age == "[0-10)" ~ 5,
    age == "[10-20)" ~ 15,
    age == "[20-30)" ~ 25,
    age == "[30-40)" ~ 35,
    age == "[40-50)" ~ 45,
    age == "[50-60)" ~ 55,
    age == "[60-70)" ~ 65,
    age == "[70-80)" ~ 75,
    age == "[80-90)" ~ 85,
    age == "[90-100)" ~ 95,
    TRUE ~ NA_real_
  ))

# 8. Create binary readmission outcome
diab <- diab %>%
  mutate(readmitted_binary = case_when(
    readmitted == "<30" ~ 1,
    TRUE ~ 0
  ))

cleaned_diab <- diab

print(cleaned_diab)
```

## Exploratory Data Analysis (EDA)

```{r}
library(RColorBrewer)

# Consistent clean theme
clean_theme <- theme_light(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold"),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "gray80", fill = NA)
  )

theme_set(clean_theme)
```

```{r}
# -------------------------------
# 1. Missing Value Summary
# -------------------------------
missing_summary <- cleaned_diab %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "missing") %>%
  filter(missing > 0)

ggplot(missing_summary, aes(x = reorder(variable, -missing), y = missing)) +
  geom_col(fill = "#6395F9") +
  coord_flip() +
  scale_y_continuous(labels = comma_format()) +
  labs(
    title = "Missing Values by Variable",
    x = "Variable",
    y = "Count of Missing Values"
  ) +
  theme_minimal(base_size = 13)

# -------------------------------
# 2. Age Distribution
# -------------------------------
age_order <- c("[0-10)", "[10-20)", "[20-30)", "[30-40)", "[40-50)", 
               "[50-60)", "[60-70)", "[70-80)", "[80-90)", "[90-100)")

ggplot(cleaned_diab, aes(x = factor(age, levels = age_order))) +
  geom_bar(fill = brewer.pal(8, "Oranges")[5], color = "black", linewidth = 0.3) +
  labs(title = "Age Bracket Distribution",
       x = "Age Bracket",
       y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# -------------------------------
# 3. Readmission Patterns
# -------------------------------
## Raw readmission
ggplot(cleaned_diab, aes(x = fct_infreq(readmitted))) +
  geom_bar(fill = brewer.pal(8, "Blues")[5], color = "black", linewidth = 0.3) +
  labs(title = "Raw Distribution of Readmission Outcomes",
       x = "Readmission Category",
       y = "Count")

## Binary readmission
ggplot(cleaned_diab, aes(x = as.factor(readmitted_binary))) +
  geom_bar(fill = brewer.pal(8, "RdPu")[7], color = "black", linewidth = 0.3) +
  labs(title = "Binary Readmission (<30 Days) Distribution",
       x = "Readmitted <30 Days (1 = Yes)",
       y = "Count") +
  scale_x_discrete(labels = c("0" = "No", "1" = "Yes"))

# -------------------------------
# 4. Clinical Features
# -------------------------------
## Time in hospital
ggplot(cleaned_diab, aes(x = time_in_hospital)) +
  geom_histogram(binwidth = 1, fill = brewer.pal(8, "Oranges")[6], color = "black", linewidth = 0.3) +
  labs(title = "Distribution of Time in Hospital",
       x = "Days",
       y = "Frequency")

## Number of medications
ggplot(cleaned_diab, aes(x = num_medications)) +
  geom_histogram(binwidth = 2, fill = brewer.pal(8, "Greens")[6], color = "black", linewidth = 0.3) +
  labs(title = "Number of Medications per Encounter",
       x = "Medication Count",
       y = "Frequency")

## Number of lab procedures
ggplot(cleaned_diab %>% filter(!is.na(num_lab_procedures)), aes(x = num_lab_procedures)) +
  geom_histogram(binwidth = 5, fill = brewer.pal(8, "Purples")[6], color = "black", linewidth = 0.3) +
  labs(title = "Number of Lab Procedures",
       x = "Count",
       y = "Frequency")

```
